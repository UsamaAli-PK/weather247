{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}API Integration Management - {{ site_title|default:"Django Admin" }}{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .api-dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }
    
    .api-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .api-card h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
    }
    
    .provider-list {
        list-style: none;
        padding: 0;
    }
    
    .provider-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #417690;
    }
    
    .provider-item.inactive {
        border-left-color: #dc3545;
        opacity: 0.7;
    }
    
    .provider-item.unhealthy {
        border-left-color: #ffc107;
    }
    
    .provider-status {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-healthy {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .status-unhealthy {
        background: #fff3cd;
        color: #856404;
    }
    
    .health-check-btn {
        background: #417690;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .health-check-btn:hover {
        background: #2e5266;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .metric-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    
    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #417690;
    }
    
    .metric-label {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
    }
    
    .real-time-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
        animation: pulse 2s infinite;
    }
    
    .real-time-indicator.active {
        background: #28a745;
    }
    
    .real-time-indicator.inactive {
        background: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .alert-panel {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .alert-item {
        padding: 8px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid;
    }
    
    .alert-critical {
        border-left-color: #dc3545;
        background: #f8d7da;
    }
    
    .alert-warning {
        border-left-color: #ffc107;
        background: #fff3cd;
    }
    
    .alert-info {
        border-left-color: #17a2b8;
        background: #d1ecf1;
    }
    
    .bulk-actions {
        margin: 20px 0;
        text-align: center;
    }
    
    .bulk-action-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 0 10px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .bulk-action-btn:hover {
        background: #218838;
    }
    
    .monitoring-controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<h1>API Integration Management 
    <span class="real-time-indicator active" id="real-time-indicator"></span>
    <small>Real-time Monitoring</small>
</h1>

<!-- Monitoring Controls -->
<div class="monitoring-controls">
    <button class="bulk-action-btn" onclick="startRealTimeMonitoring()">Start Monitoring</button>
    <button class="bulk-action-btn" onclick="performBulkHealthCheck()">Check All Providers</button>
    <button class="bulk-action-btn" onclick="toggleAutoRefresh()">
        <span id="auto-refresh-text">Enable Auto-Refresh</span>
    </button>
</div>

<div class="loading" id="loading">Loading API statistics...</div>
<div class="error" id="error" style="display: none;"></div>

<div id="api-content" style="display: none;">
    <!-- Latest Alerts -->
    <div class="alert-panel" id="alerts-panel">
        <h3>Latest System Alerts</h3>
        <div id="alerts-list">
            <!-- Alerts will be populated by JavaScript -->
        </div>
    </div>

    <!-- Summary Metrics -->
    <div class="metrics-grid" id="summary-metrics">
        <!-- Metrics will be populated by JavaScript -->
    </div>

    <!-- Main Dashboard -->
    <div class="api-dashboard">
        <!-- Provider Status -->
        <div class="api-card">
            <h3>API Providers</h3>
            <ul class="provider-list" id="provider-list">
                <!-- Providers will be populated by JavaScript -->
            </ul>
        </div>

        <!-- Usage Chart -->
        <div class="api-card">
            <h3>API Usage Trends</h3>
            <div class="chart-container">
                <canvas id="usageChart"></canvas>
            </div>
        </div>

        <!-- Response Time Chart -->
        <div class="api-card">
            <h3>Response Time Trends</h3>
            <div class="chart-container">
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>

        <!-- Failover Events -->
        <div class="api-card">
            <h3>Recent Failover Events</h3>
            <div id="failover-events">
                <!-- Failover events will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
let autoRefreshEnabled = false;
let autoRefreshInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAPIStats();
    loadLatestAlerts();
    
    // Initial real-time status check
    loadRealTimeStatus();
});

async function loadAPIStats() {
    try {
        const response = await fetch('{% url "admin:api_stats_api" %}');
        const data = await response.json();
        
        if (data.error) {
            showError(data.error);
            return;
        }
        
        hideLoading();
        renderSummaryMetrics(data.summary);
        renderProviders(data.providers);
        renderCharts(data.providers);
        
    } catch (error) {
        showError('Failed to load API statistics: ' + error.message);
    }
}

function renderSummaryMetrics(summary) {
    const container = document.getElementById('summary-metrics');
    container.innerHTML = `
        <div class="metric-card">
            <div class="metric-value">${summary.total_providers}</div>
            <div class="metric-label">Total Providers</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">${summary.active_providers}</div>
            <div class="metric-label">Active Providers</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">${summary.healthy_providers}</div>
            <div class="metric-label">Healthy Providers</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">${summary.health_percentage.toFixed(1)}%</div>
            <div class="metric-label">Health Rate</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">${summary.recent_failovers}</div>
            <div class="metric-label">Recent Failovers</div>
        </div>
    `;
}

function renderProviders(providers) {
    const container = document.getElementById('provider-list');
    container.innerHTML = providers.map(provider => {
        const p = provider.provider;
        const usage = provider.usage;
        
        const statusClass = p.is_active ? 
            (p.is_healthy ? '' : 'unhealthy') : 'inactive';
        
        return `
            <li class="provider-item ${statusClass}">
                <div>
                    <strong>${p.display_name}</strong>
                    <br>
                    <small>Requests: ${usage.total_requests} | Success Rate: ${usage.success_rate}%</small>
                </div>
                <div class="provider-status">
                    <span class="status-badge ${p.is_active ? 'status-active' : 'status-inactive'}">
                        ${p.is_active ? 'Active' : 'Inactive'}
                    </span>
                    <span class="status-badge ${p.is_healthy ? 'status-healthy' : 'status-unhealthy'}">
                        ${p.is_healthy ? 'Healthy' : 'Unhealthy'}
                    </span>
                    <button class="health-check-btn" onclick="performHealthCheck(${p.id})">
                        Check Health
                    </button>
                </div>
            </li>
        `;
    }).join('');
}

function renderCharts(providers) {
    // Usage Chart
    const usageCtx = document.getElementById('usageChart').getContext('2d');
    const usageData = providers.map(p => ({
        label: p.provider.display_name,
        data: p.daily_usage.map(d => d.requests),
        borderColor: getRandomColor(),
        fill: false
    }));
    
    new Chart(usageCtx, {
        type: 'line',
        data: {
            labels: providers[0]?.daily_usage.map(d => d.date) || [],
            datasets: usageData
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Response Time Chart
    const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
    const responseData = providers.map(p => ({
        label: p.provider.display_name,
        data: p.daily_usage.map(d => d.avg_response_time),
        borderColor: getRandomColor(),
        fill: false
    }));
    
    new Chart(responseCtx, {
        type: 'line',
        data: {
            labels: providers[0]?.daily_usage.map(d => d.date) || [],
            datasets: responseData
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Response Time (seconds)'
                    }
                }
            }
        }
    });
}

async function performHealthCheck(providerId) {
    try {
        const response = await fetch(`{% url "admin:health_check_api" provider_id=0 %}`.replace('0', providerId));
        const result = await response.json();
        
        if (result.error) {
            alert('Health check failed: ' + result.error);
        } else {
            alert(`Health check completed for ${result.provider}:\n` +
                  `Status: ${result.healthy ? 'Healthy' : 'Unhealthy'}\n` +
                  `Response Time: ${result.response_time || 'N/A'}s`);
        }
        
        // Refresh the data
        loadAPIStats();
        
    } catch (error) {
        alert('Health check failed: ' + error.message);
    }
}

function getRandomColor() {
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

async function loadRealTimeStatus() {
    try {
        const response = await fetch('{% url "admin:real_time_status_api" %}');
        const data = await response.json();
        
        if (data.error) {
            console.error('Real-time status error:', data.error);
            return;
        }
        
        updateRealTimeIndicator(data.system_health);
        
    } catch (error) {
        console.error('Failed to load real-time status:', error);
    }
}

async function loadLatestAlerts() {
    try {
        const response = await fetch('{% url "admin:latest_alerts_api" %}?limit=5');
        const data = await response.json();
        
        if (data.error) {
            console.error('Alerts error:', data.error);
            return;
        }
        
        renderAlerts(data.alerts);
        
    } catch (error) {
        console.error('Failed to load alerts:', error);
    }
}

function renderAlerts(alerts) {
    const container = document.getElementById('alerts-list');
    
    if (alerts.length === 0) {
        container.innerHTML = '<p style="color: #28a745;">No active alerts</p>';
        return;
    }
    
    container.innerHTML = alerts.map(alert => {
        const alertClass = `alert-${alert.severity}`;
        const timeAgo = new Date(alert.created_at).toLocaleString();
        
        return `
            <div class="alert-item ${alertClass}">
                <strong>${alert.title}</strong>
                <br>
                <small>${alert.message}</small>
                <br>
                <small style="color: #666;">${timeAgo}</small>
            </div>
        `;
    }).join('');
}

function updateRealTimeIndicator(systemHealth) {
    const indicator = document.getElementById('real-time-indicator');
    
    indicator.className = 'real-time-indicator';
    
    if (systemHealth === 'healthy') {
        indicator.classList.add('active');
    } else {
        indicator.classList.add('inactive');
    }
}

async function startRealTimeMonitoring() {
    try {
        const response = await fetch('{% url "admin:api_start_monitoring" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Failed to start monitoring: ' + result.error);
        } else {
            alert('Real-time monitoring started successfully');
            loadRealTimeStatus();
        }
        
    } catch (error) {
        alert('Failed to start monitoring: ' + error.message);
    }
}

async function performBulkHealthCheck() {
    try {
        const response = await fetch('{% url "admin:bulk_health_check_api" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Bulk health check failed: ' + result.error);
        } else {
            let message = `Health check completed for ${result.total_checked} providers:\n\n`;
            result.results.forEach(r => {
                message += `${r.display_name}: ${r.healthy ? 'Healthy' : 'Unhealthy'}`;
                if (r.response_time) {
                    message += ` (${r.response_time.toFixed(2)}s)`;
                }
                if (r.error) {
                    message += ` - ${r.error}`;
                }
                message += '\n';
            });
            
            alert(message);
            loadAPIStats();
            loadRealTimeStatus();
        }
        
    } catch (error) {
        alert('Bulk health check failed: ' + error.message);
    }
}

function toggleAutoRefresh() {
    const button = document.getElementById('auto-refresh-text');
    
    if (autoRefreshEnabled) {
        // Disable auto-refresh
        autoRefreshEnabled = false;
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        button.textContent = 'Enable Auto-Refresh';
    } else {
        // Enable auto-refresh
        autoRefreshEnabled = true;
        autoRefreshInterval = setInterval(() => {
            loadAPIStats();
            loadLatestAlerts();
            loadRealTimeStatus();
        }, 30000); // 30 seconds
        button.textContent = 'Disable Auto-Refresh';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').textContent = message;
    document.getElementById('api-content').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('api-content').style.display = 'block';
}
</script>
{% endblock %}